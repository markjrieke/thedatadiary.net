{
  "hash": "9285adf36180dc5590ef49811f3018ca",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"MADHATTRS\"\ndate: '2025-03-16'\ncategories: [stan, march madness]\ndescription: \"An introduction to and description of a March Madness forecasting system\"\nimage: header.png\nexecute: \n  echo: false\nhtml:\n  fig-width: 9\n  fig-height: 9\nfilters:\n  - add-code-files\n---\n\n::: {.cell}\n\n:::\n\n\n\n### Introduction\n\nThis year, I'm launching my first-ever March Madness forecast for both the [men's](../../projects/2025-march-madness/mens.qmd) and [women's](../../projects/2025-march-madness/womens.qmd) tournaments. Every day, the forecast simulates thousands of potential tournament outcomes to see how far each team will advance and which team has the greatest chance of winning the national title.\n\nPowering the forecast is the first iteration of the **MADHATTRS**^[This is a not-so-subtle nod to my family's long-standing March Madness bracket group name, MadHatters.] system. MADHATTRS --- which stands for **M**ultivariate **A**ttack / **D**efense / **H**ome **A**djustments **T**o **T**eam **R**atings (via) **S**imulation^[What would any forecast be without a wonky [backronym](https://en.wikipedia.org/wiki/Backronym)?] --- is a series of models that estimates each team's offensive and defensive strength as well as their home-court advantage. Like other [Elo](https://en.wikipedia.org/wiki/Elo_rating_system)-adjacent [systems](https://fivethirtyeight.com/methodology/how-our-wnba-predictions-work/), MADHATTRS is applied at the team (rather than player) level.^[Examples of player-level metrics include FiveThirtyEight's [RAPTOR](https://fivethirtyeight.com/features/introducing-raptor-our-new-metric-for-the-modern-nba/) or ESPN's [real plus-minus](https://www.espn.com/nba/story/_/id/28309836/how-real-plus-minus-reveal-hidden-nba-stars).] Unlike other systems, MADHATTRS is fully [Bayesian](https://en.wikipedia.org/wiki/Bayesian_statistics) under-the-hood and enjoys all the benefits of Bayesian inference --- most importantly, propagating uncertainty throughout the system.\n\nAs always, this work is fully open source --- code to [prep data](https://github.com/markjrieke/2025-march-madness/tree/main/R/model/functions), fit the [models](https://github.com/markjrieke/2025-march-madness/tree/main/stan), and [render site graphics](https://github.com/markjrieke/2025-march-madness/tree/main/R/site) can found in the project's [repository on GitHub](https://github.com/markjrieke/2025-march-madness). The READMEs throughout the repository describe the system in detail but I provide a high-level overview of the core components of the forecast below.\n\n### The whole game\n\nMADHATTRS is split into several different models but each has the same two fundamental objectives:\n\n* To estimate each team's rate of points-per-minute (PPM) in each game.\n* To estimate the number of overtimes played in each game.\n\nEach team's PPM is a function of their offensive output, their opponent's defensive skill, and whether or not they have a home-court advantage. When playing away from home --- either as the away team or on neutral territory --- the *Home Advantage* goes to 0 and doesn't contribute to PPM. Adjustments to PPM are made relative to a fixed point, 1.75 PPM, which translates to an expected 70 points in 40 minutes of regulation.^[This fixed point is picked somewhat arbitrarily --- the exact value doesn't matter, just that adjustments are made relative to this value.]\n\n$$\n\\text{PPM} \\sim \\text{Offense} - \\text{Opponent Defense} + \\text{Home Advantage}\n$$\n\nThe number of overtimes played is modeled by scaling the absolute difference between each team's PPM.^[*Technically*, I estimate both the probability of the game going to overtime *and* the number of overtimes via a [hurdle model](https://mc-stan.org/docs/stan-users-guide/finite-mixtures.html#hurdle-models).] Games between two teams with similar PPMs --- be they high or low skill --- are likelier to go to overtime than lopsided games between a low-skilled team and a powerhouse. \n\n$$\n\\text{Overtimes} \\sim \\text{Scaling Factor} \\times \\left| \\text{PPM}_{\\text{home}} - \\text{PPM}_{\\text{away}} \\right|\n$$\n\nThat's pretty much it! All the other components below are slight variations on these two core pillars. I'll walk through each component using my [alma mater](https://www.youtube.com/watch?v=yVBYcANXfXs), the University of Tulsa, as an example.\n\n### History, not a mystery\n\nFor the 2001-02 through 2023-24 seasons, MADHATTRS estimates each team's offensive, defensive, and home-court adjustments to PPM by iteratively fitting an entire season's worth of data at a time. Since players graduate, leave for the NBA/WNBA, transfer, or simply get better/worse at the game, the historical model uses a pseudo-[random walk](https://mc-stan.org/docs/functions-reference/distributions_over_unbounded_vectors.html#gaussian-dynamic-linear-models) that allows each team's parameters to drift from season to season. In this pseudo-random walk, the [prior](https://en.wikipedia.org/wiki/Prior_probability) for each season is the [posterior](https://en.wikipedia.org/wiki/Posterior_probability) from the previous season plus a bit of noise.  \nThis means that --- especially at the beginning of each season --- we tend to expect teams to be similarly ranked near where they were in the previous season.\n\nTulsa's basketball teams, for example, have defensive PPM adjustments that bounce somewhere between 0.0 and 0.2 PPM on average over the years, though the value drifts from season to season. This translates to an average reduction in their opponent's score between 0 and 8 points in games ending in regulation. \n\n\n\n::: {.cell}\n\n:::\n\n\n\n::: {.panel-tabset}\n\n#### Men's\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/historical paramters mens-1.png){width=2700}\n:::\n:::\n\n\n\n#### Women's\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/historical parameters womens-1.png){width=2700}\n:::\n:::\n\n\n\n:::\n\nA similar psuedo-random walk method is used to estimate the probability of a game going to overtime. \n\n\n\n::: {.cell}\n\n:::\n\n\n\n::: {.panel-tabset}\n\n#### Men's\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){width=2700}\n:::\n:::\n\n\n\n#### Women's\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=2700}\n:::\n:::\n\n\n\n:::\n  \n### Season's greetings\n\nThe 2024-25 season model is essentially the same as the historical model. The differences lie mostly in how the model is run and what output is stored. \n\nMuch like the historical model, the current season uses the previous season's posterior as a prior to estimate season-level parameters. Unlike the historical model, the current season's model is refit every day that at least one game is played. As the season progresses, the uncertainty around each parameter's estimate decreases.\n\n\n\n::: {.cell}\n\n:::\n\n\n\n::: {.panel-tabset}\n\n#### Men's\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/team parameters mens-1.png){width=2700}\n:::\n:::\n\n\n\n#### Women's\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/team parameters womens-1.png){width=2700}\n:::\n:::\n\n\n\n:::\n\nPICK UP HERE DAWG\n\n* daily season updates\n  * Tulsa mens/womens parameters from beginning of season -> now\n  * use the output from pre-season as a prior for the current season\n  * really really similar to the pre-season training, but we save the daily output\n  * as the season progresses, the uncertainty around team ratings shrinks\n  * save the correlation structure for offensive/defensive/home advantage ratings\n\n\n\n::: {.cell}\n\n:::\n\n\n\n::: {.panel-tabset}\n\n#### Men's\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=2700}\n:::\n:::\n\n\n\n#### Women's\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=2700}\n:::\n:::\n\n\n\n:::\n\n\n\n::: {.cell}\n\n:::\n\n\n\n::: {.panel-tabset}\n\n#### Men's\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=2700}\n:::\n:::\n\n\n\n#### Women's\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=2700}\n:::\n:::\n\n\n\n:::\n\n  \n### Predictions in retrograde\n\n\n\n::: {.cell}\n\n:::\n\n\n\n::: {.panel-tabset}\n\n#### Men's\n\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/mens predictions plot-1.png){width=2700}\n:::\n:::\n\n\n\n#### Women's\n\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/womens predictions plot-1.png){width=2700}\n:::\n:::\n\n\n\n:::\n\n* prediction\n  * tulsa mens/womens vs oru mens/womens blobs as of 3/16\n  * same as the training, but in reverse!\n  * does the game go to overtime?\n  * does how many overtimes are played?\n  * rate of scoring for each team given number of minutes\n  * estimate mixed scoring distribution(s)\n  \nIn the regular season, MADHATTRS can estimate the outcome of individual games. During the playoffs, it considers the strength of *potential* schedules each team could face when projecting each team's probability of advancing. \n  \n### bracket title\n\n* bracket\n  * uses the same prediction model described above\n  * in each simulation, the winner advances\n  * so you end up simulating very normal tournaments where 1/2 seeds all beat the 15/16 seess\n  * but also weird edge cases where there's lots of upsets\n  * the result is a mixture of possible tournament outcomes\n  \n\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}